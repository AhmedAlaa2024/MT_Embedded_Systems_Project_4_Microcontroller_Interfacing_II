 /******************************************************************************
 *
 * Module: HCSR04 Ultrasonic Sensor
 *
 * File Name: HCSR04_ultrasonic_sensor.c
 *
 * Description: Source file for the AVR HCSR04 Ultrasonic Sensor driver
 *
 * Author: Ahmed Alaa
 *
 *******************************************************************************/
#include "HCSR04_ultrasonic_sensor.h"
#include "icu.h"
#include "gpio.h"
#include "util/delay.h"
/*******************************************************************************
 *                         		Static Global Variables  		               *
 *******************************************************************************/
static double distance = 0;
static Icu_ConfigType Config_Struct =
{
		F_CPU_8,
		RISING
};
static uint8 data_is_ready = 0;
/*******************************************************************************
 *                              		Functions  		                       *
 *******************************************************************************/
/*
 * Description :
 * 1. Initialize the ICU driver as required.
 * 2. Setup the ICU call back function.
 * 3. Setup the direction for the trigger pin as output pin through the GPIO driver.
 * Inputs:
 * 		None
 * Outputs:
 * 		None
 */
void Ultrasonic_init(void)
{
	Icu_setCallBack(Ultrasonic_edgeProcessing);
	Icu_init(&Config_Struct);
	GPIO_setupPinDirection(PORTB_ID, PIN4_ID, PIN_OUTPUT);
}

/*
 * Description :
 * 1. Send the Trigger pulse to the ultrasonic.
 * Inputs:
 * 		None
 * Outputs:
 * 		None
 */
static void Ultrasonic_Trigger(void)
{
	Icu_clearTimerValue();
	Icu_setEdgeDetectionType(RISING);
	Config_Struct.edge == RISING;

	GPIO_writePin(PORTB_ID, PIN4_ID, LOGIC_HIGH);
	_delay_us(10);
	GPIO_writePin(PORTB_ID, PIN4_ID, LOGIC_LOW);
}

/*
 * Description :
 * 1. Send the trigger pulse by using Ultrasonic_Trigger function.
 * 2. Start the measurements by the ICU from this moment.
 * Inputs:
 * 		None
 * Outputs:
 * 		The measured distance in Centimeter.
 */
uint16 Ultrasonic_readDistance(void)
{
	Ultrasonic_Trigger();
	while(!data_is_ready);
	return distance;
}

/*
 * Description :
 * 1. This is the call back function called by the ICU driver.
 * 2. This is used to calculate the high time (pulse time) generated by the ultrasonic sensor.
 * Inputs:
 * 		None
 * Outputs:
 * 		None
 */
void Ultrasonic_edgeProcessing(void)
{
	if(Config_Struct.edge == RISING)
	{
		data_is_ready = 0;
		Icu_clearTimerValue();
		Icu_setEdgeDetectionType(FALLING);
		Config_Struct.edge = FALLING;
	}
	else if (Config_Struct.edge == FALLING)
	{
		distance = (double)(Icu_getInputCaptureValue() / 58.8);
		data_is_ready = 1;
	}
}
